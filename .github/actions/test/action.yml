# https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
name: "e2e suite"
description: "Run Leviathan e2e suite on a matrix of device types"

# additional secrets and vars must be written to .env, base64 encoded, and added to COMPOSE_VARS

# > cat .env
# BALENACLOUD_ORG=testbot
# BALENACLOUD_APP_NAME=balena/testbot-rig
# BALENACLOUD_API_KEY=********

# > base64 -w0 .env

inputs:
  json:
    description: "JSON stringified object containing all the inputs from the calling workflow"
    required: true
  secrets:
    description: "JSON stringified object containing all the secrets from the calling workflow"
    required: true
runs:
  using: "composite"

  steps:
    - uses: actions/checkout@v3
      with:
        submodules: true

    - name: Set environment
      shell: bash
      env:
        SUITES: ./suites
        REPORTS: ./reports
        WORKSPACE: ./workspace
        QEMU_CPUS: "1"
        QEMU_MEMORY: 1G
        COMPOSE_VARS: ${{ fromJSON(inputs.secrets).COMPOSE_VARS }}
      run: |
        echo "SUITES=${SUITES}" >> $GITHUB_ENV
        echo "REPORTS=${REPORTS}" >> $GITHUB_ENV
        echo "WORKSPACE=${WORKSPACE}" >> $GITHUB_ENV
        echo "QEMU_CPUS=${QEMU_CPUS}" >> $GITHUB_ENV
        echo "QEMU_MEMORY=${QEMU_MEMORY}" >> $GITHUB_ENV
        echo "WORKER_TYPE=${matrix_value%%-*}" >> $GITHUB_ENV
        echo "DEVICE_TYPE=${matrix_value#*-}" >> $GITHUB_ENV
        echo "${COMPOSE_VARS}" | base64 --decode > .env

    - name: Copy suite config
      shell: bash
      run: cp -a ${{ env.SUITES }}/config.js ${{ env.WORKSPACE }}/config.js

    - name: Build leviathan images
      shell: bash
      run: make build

    - name: Run test suite
      shell: bash
      run: make test

    - uses: actions/upload-artifact@v3
      with:
        name: reports-${{ env.WORKER_TYPE }}-${{ env.DEVICE_TYPE }}
        path: ${{ env.REPORTS }}
