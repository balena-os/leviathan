FROM balenalib/%%BALENA_ARCH%%-alpine-node:14.18-20211208 AS npm-install

ENV npm_config_unsafe_perm true

WORKDIR /tmp/node

# hadolint ignore=DL3018
RUN apk add --no-cache git python3 make build-base linux-headers

COPY package*.json ./

RUN npm ci

FROM balenalib/%%BALENA_ARCH%%-alpine:3.14-run-20211207

ENV UDEV 1
ENV DBUS_SYSTEM_BUS_ADDRESS unix:path=/host/run/dbus/system_bus_socket

# hadolint ignore=DL3018
RUN apk add --no-cache nodejs=~14.18.1 \
		       jq \
		       git \
		       vim \
		       rsync \
		       unzip \
		       bluez \
		       skopeo \
		       openssh-client

WORKDIR /usr/app

COPY --from=npm-install /tmp/node ./

# Install balena binary & npm in PATH
RUN ln -sf /usr/app/node_modules/balena-cli/bin/balena /usr/bin/balena && \
    balena version && \
    ln -sf /usr/app/node_modules/npm/bin/npm-cli.js /usr/bin/npm && \
    npm --version

COPY contracts contracts
COPY lib lib
COPY config config
COPY entry.sh ./

CMD [ "./entry.sh" ]
