<!doctype html>
<html class="default no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Autokit worker | Leviathan Helpers</title>
	<meta name="description" content="Documentation for Leviathan Helpers">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="../../../assets/css/main.css">
	<link rel="stylesheet" href="../../../assets/css/pages.css">
</head>
<body>
<header>
	<div class="tsd-page-toolbar">
		<div class="container">
			<div class="table-wrap">
				<div class="table-cell" id="tsd-search" data-index="../../../assets/js/search.json" data-base="../../..">
					<div class="field">
						<label for="tsd-search-field" class="tsd-widget search no-caption">Search</label>
						<input id="tsd-search-field" type="text" />
					</div>
					<ul class="results">
						<li class="state loading">Preparing search index...</li>
						<li class="state failure">The search index is not available</li>
					</ul>
					<a href="../../../index.html" class="title">Leviathan Helpers</a>
				</div>
				<div class="table-cell" id="tsd-widgets">
					<div id="tsd-filter">
						<a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a>
						<div class="tsd-filter-group">
							<div class="tsd-select" id="tsd-filter-visibility">
								<span class="tsd-select-label">All</span>
								<ul class="tsd-select-list">
									<li data-value="public">Public</li>
									<li data-value="protected">Public/Protected</li>
									<li data-value="private" class="selected">All</li>
								</ul>
							</div>
							<input type="checkbox" id="tsd-filter-inherited" checked />
							<label class="tsd-widget" for="tsd-filter-inherited">Inherited</label>
							<input type="checkbox" id="tsd-filter-only-exported" />
							<label class="tsd-widget" for="tsd-filter-only-exported">Only exported</label>
						</div>
					</div>
					<a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a>
				</div>
			</div>
		</div>
	</div>
	<div class="tsd-page-title">
		<div class="container">
			<ul class="tsd-breadcrumb">
				<li>
					<a href="../../../modules.html">Globals</a>
				</li>
				<li>
					<a href="../quickstart.html">Getting-Started</a>
				</li>
				<li>
					<a href="../quickstart.html">Quickstart</a>
				</li>
				<li>
					<a href="quickstart-autokit.html">Autokit worker</a>
				</li>
			</ul>
			<h1>Autokit worker</h1>
		</div>
	</div>
</header>
<div class="container container-main">
	<div class="row">
		<div class="col-8 col-content">
			<div class="tsd-panel tsd-typography">
				<a href="#getting-started-with-autokit-worker" id="getting-started-with-autokit-worker" style="color: inherit; text-decoration: none;">
					<h1>Getting Started with Autokit Worker</h1>
				</a>
				<p>This is a quick start guide for using the leviathan framework with the autokit worker.</p>
				<a href="#as-a-prerequisite" id="as-a-prerequisite" style="color: inherit; text-decoration: none;">
					<h2>As a prerequisite</h2>
				</a>
				<ol>
					<li>Make sure you have built your autokit using the following <a href="https://github.com/balena-io-hardware/autokit-assembly-doc">guide</a></li>
					<li>Go through the steps listed on the <a href="../quickstart.html">Quickstart Page</a></li>
				</ol>
				<a href="#provision-your-autokit-into-a-leviathan-worker-fleet" id="provision-your-autokit-into-a-leviathan-worker-fleet" style="color: inherit; text-decoration: none;">
					<h2>Provision your autokit into a leviathan-worker fleet</h2>
				</a>
				<p>To use the autokit with the leviathan framework, your autokit must be running a <a href="https://github.com/balena-os/leviathan-worker">leviathan-worker</a> container. We recommed provisioning the autokit host to a balena fleet:</p>
				<ol>
					<li>If you don&#39;t already have access to a fleet, <a href="https://docs.balena.io/learn/getting-started/raspberrypi3/nodejs/#create-a-fleet">create one</a></li>
					<li>Navigate to the <a href="https://github.com/balena-os/leviathan-worker">leviathan-worker</a> repository. Clone it, and from that repository use <code>balena push</code> to <a href="https://docs.balena.io/learn/deploy/deployment/#overview">push a new release to your fleet</a></li>
					<li><a href="https://docs.balena.io/learn/deploy/deployment/#overview">Provision</a> your autokit to this fleet. Depending on the device-type of your autokit host, the process may differ. Ensure that you provision the device using the image configured to use <strong>ethernet only</strong>. </li>
					<li>When the device is successfully provisioned on balenaCloud, make sure to enable the public URL for your device.</li>
					<li>Add the appropriate environment variables to the device. You may have to adjust these depending on the autokit setup and the device under test. The main ones, relevant to the leviathan-worker are:</li>
				</ol>
				<table>
					<thead>
						<tr>
							<th>Variable Name</th>
							<th>Description</th>
							<th>Required</th>
						</tr>
					</thead>
					<tbody><tr>
							<td><code>TESTBOT_DUT_TYPE</code></td>
							<td>Set to the device type slug of the DUT from the <a href="https://github.com/balena-io-hardware/autokit-interface-sw/tree/master/lib/flashing/devices">supported devices</a> listed here. If your DUT is not listed, then proceed to choose the device type that resembles the flashing procedure of the DUT. For example, a flashing a sd card and booting process resembles the process of <code>raspberrypi4-64</code>. Similarly, for a flasher image use <code>intel-nuc</code>.</td>
							<td>True</td>
						</tr>
						<tr>
							<td><code>WORKER_TYPE</code></td>
							<td>Set to the type of worker you intend to use with Leviathan. In this case, it&#39;s an autokit. Hence, set to <code>autokit</code>.</td>
							<td>True</td>
						</tr>
						<tr>
							<td>Autokit Setup Variables</td>
							<td>Refer to the <a href="https://github.com/balena-os/leviathan-worker/blob/master/lib/workers/autokit.ts#L17">autokit setup variables</a> and ensure they are appropriately configured if any hardware differs from the default. Cross-reference these strings with the <a href="https://github.com/balena-io-hardware/autokit-interface-sw/tree/master/lib/features">autokit feature implementations</a> for more information.</td>
							<td></td>
						</tr>
				</tbody></table>
				<p>Any other relevent autokit variables must be set, if the default values aren&#39;t appropriate</p>
				<table>
					<thead>
						<tr>
							<th>Variable Name</th>
							<th>Description</th>
							<th>Default</th>
							<th>Required</th>
						</tr>
					</thead>
					<tbody><tr>
							<td><code>WIFI_IF</code></td>
							<td>The name of the primary WiFi interface of the autokit host.</td>
							<td><code>wlan0</code></td>
							<td>No</td>
						</tr>
						<tr>
							<td><code>WIRED_IF</code></td>
							<td>The name of the USB-Ethernet interface of the autokit host. This can be found by accessing the autokit host over SSH.</td>
							<td><code>eth0</code></td>
							<td>No</td>
						</tr>
						<tr>
							<td><code>DEV_SERIAL</code></td>
							<td>The name of the USB-serial interface of the autokit.</td>
							<td><code>/dev/ttyUSB0</code></td>
							<td>No</td>
						</tr>
				</tbody></table>
				<ol start="6">
					<li>When that the <code>worker</code> container on your autokit host has started, the logs in the dashboard should read the message <code>worker setup completed</code>. If the container is not starting, the most likely cause could be either the hardware not plugged in correctly, or the needed env vars weren&#39;t set up correctly.</li>
					<li>Lastly, add a device tag for your autokit in balenaCloud. The tag will be for the key named &quot;DUT&quot; with the value being the slug of the device under test. For example, the following as a balenaCloud device tag.</li>
				</ol>
				<pre><code><span style="color: #002339">DUT: </span><span style="color: #2F86D2">raspberrypi3</span>
</code></pre>
				<p>Future work will simplify this process to avoid manual configuration of environment variables where possible.</p>
				<a href="#start-your-first-test-run" id="start-your-first-test-run" style="color: inherit; text-decoration: none;">
					<h2>Start your first test run</h2>
				</a>
				<p>For your first test run, we will be running the <a href="https://github.com/balena-os/leviathan/tree/master/suites/e2e">e2e test suite</a>. This is a basic testing suite to test your worker configuration and if the setup is correct. Each Levaithan test run needs the following to start testing that the user has to provide:</p>
				<ol>
					<li><strong>The test suite you want to run</strong>: <a href="https://github.com/balena-os/leviathan/tree/master/suites/e2e">e2e test suite</a> (already provided)</li>
					<li><strong>A balenaOS image used to flash, provision and test the DUT</strong>. The test will automatically download an OS image this time. So no need to provide your own image.  </li>
					<li><strong>A test configuration using the <code>config.js</code> file</strong>: Let&#39;s create one.</li>
				</ol>
				<a href="#build-your-configjs-file" id="build-your-configjs-file" style="color: inherit; text-decoration: none;">
					<h3>Build your <code>config.js</code> file</h3>
				</a>
				<p>The <code>config.js</code> file is the master configuration file for your test run. Leviathan runs and configures your device under test (DUT) according to the settings configured under <code>config.js</code> file. To know more about each property, refer to the <a href="../config-reference.html">Config.js reference</a>.</p>
				<p>Create your own config.js file</p>
				<ul>
					<li>Navigate to the <code>workspace</code> directory in leviathan.</li>
					<li>Create a <code>config.js</code> file in the <code>workspace</code> directory and paste the contents below.</li>
				</ul>
				<pre><code class="language-js"><span style="color: #DC3EB7">module</span><span style="color: #002339">.</span><span style="color: #DC3EB7">exports</span><span style="color: #002339"> </span><span style="color: #7B30D0">=</span><span style="color: #002339"> {</span>
<span style="color: #002339">    deviceType: </span><span style="color: #A44185">&quot;raspberrypi3&quot;</span><span style="color: #002339">,</span>
<span style="color: #002339">    suite: </span><span style="color: #A44185">`${</span><span style="color: #2F86D2">__dirname</span><span style="color: #A44185">}/../suites/e2e`</span><span style="color: #002339">,</span>
<span style="color: #002339">    config: {</span>
<span style="color: #002339">        networkWired: </span><span style="color: #174781">false</span><span style="color: #002339">,</span>
<span style="color: #002339">        networkWireless: </span><span style="color: #174781">true</span><span style="color: #002339">,</span>
<span style="color: #002339">        downloadVersion: </span><span style="color: #A44185">&#039;latest&#039;</span><span style="color: #002339">,</span>
<span style="color: #002339">        balenaApiKey: </span><span style="color: #2F86D2">process</span><span style="color: #002339">.</span><span style="color: #2F86D2">env</span><span style="color: #002339">.</span><span style="color: #2F86D2">BALENACLOUD_API_KEY</span><span style="color: #002339">,</span>
<span style="color: #002339">        balenaApiUrl: </span><span style="color: #A44185">&#039;balena-cloud.com&#039;</span><span style="color: #002339">,</span>
<span style="color: #002339">        organization: </span><span style="color: #2F86D2">process</span><span style="color: #002339">.</span><span style="color: #2F86D2">env</span><span style="color: #002339">.</span><span style="color: #2F86D2">BALENACLOUD_ORG</span><span style="color: #002339">,</span>
<span style="color: #002339">    },</span>
<span style="color: #002339">    debug: {</span>
<span style="color: #002339">        unstable: [</span><span style="color: #A44185">&quot;Kill the device under test&quot;</span><span style="color: #002339">],</span>
<span style="color: #002339">    }</span>
<span style="color: #002339">    </span><span style="color: #2F86D2">image</span><span style="color: #002339">: </span><span style="color: #174781">false</span><span style="color: #002339">,</span>
<span style="color: #002339">    workers: [</span><span style="color: #A44185">&#039;&lt;Public device URL of your autokit&gt;&#039;</span><span style="color: #002339">],</span>
<span style="color: #002339">}</span>
</code></pre>
				<p>Ensure that the <code>organization</code> matches the username that owns the <code>balenaApiKey</code> - otherwise it will lead to authentication errors.</p>
				<p>To provide values of environment variables easily, you can create a <code>.env</code> file in the root of the leviathan directory. Use the format below as boilerplate. </p>
				<pre><code><span style="color: #2F86D2">WORKSPACE</span><span style="color: #7B30D0">=</span><span style="color: #002339">.</span><span style="color: #7B30D0">/</span><span style="color: #2F86D2">workspace</span>
<span style="color: #2F86D2">REPORTS</span><span style="color: #7B30D0">=</span><span style="color: #002339">.</span><span style="color: #7B30D0">/</span><span style="color: #2F86D2">workspace</span><span style="color: #7B30D0">/</span><span style="color: #2F86D2">reports</span>
<span style="color: #2F86D2">SUITES</span><span style="color: #7B30D0">=/</span><span style="color: #2F86D2">path</span><span style="color: #7B30D0">/</span><span style="color: #2F86D2">to</span><span style="color: #7B30D0">/</span><span style="color: #2F86D2">meta</span><span style="color: #7B30D0">-</span><span style="color: #2F86D2">balena</span><span style="color: #7B30D0">/</span><span style="color: #2F86D2">tests</span><span style="color: #7B30D0">/</span><span style="color: #2F86D2">suites</span>
<span style="color: #2F86D2">DEVICE_TYPE</span><span style="color: #7B30D0">=</span><span style="color: #2F86D2">raspberrypi3</span>
<span style="color: #2F86D2">BALENACLOUD_API_KEY</span><span style="color: #7B30D0">=</span><span style="color: #002339">&lt;</span><span style="color: #0444AC">api</span><span style="color: #002339"> </span><span style="color: #0444AC">key</span><span style="color: #002339">&gt;</span>
<span style="color: #2F86D2">BALENACLOUD_ORG</span><span style="color: #7B30D0">=</span><span style="color: #002339">&lt;</span><span style="color: #0444AC">org</span><span style="color: #002339">&gt;</span>
<span style="color: #2F86D2">BALENA_ARCH</span><span style="color: #7B30D0">=</span><span style="color: #2F86D2">amd64</span>
<span style="color: #2F86D2">BALENACLOUD_APP_NAME</span><span style="color: #7B30D0">=</span><span style="color: #002339">&lt;</span><span style="color: #0444AC">app</span><span style="color: #002339">-</span><span style="color: #0444AC">name</span><span style="color: #002339">&gt;</span>
</code></pre>
				<a href="#start-the-run" id="start-the-run" style="color: inherit; text-decoration: none;">
					<h3>Start the run</h3>
				</a>
				<p>To start the test run, navigate to the root of the Leviathan directory and run the following command:</p>
				<pre><code><span style="color: #2F86D2">make</span><span style="color: #002339"> </span><span style="color: #2F86D2">test</span>
</code></pre>
				<p>This will trigger a build of client and core services using docker-compose and begin the test. The logs by various componenet will start streaming on the terminal. Wait for the test scenario to finish and check the device logs on the dashboard in the meantime. </p>
				<p>A successful run of the e2e test suite without any errors makes sure that your autokit worker is set up correctly and can be used for further tests.</p>
				<a href="#let39s-run-some-quotrealquot-tests" id="let39s-run-some-quotrealquot-tests" style="color: inherit; text-decoration: none;">
					<h2>Let&#39;s run some &quot;real&quot; tests</h2>
				</a>
				<p>We will start with a test run of the <a href="https://github.com/balena-os/meta-balena/tree/master/tests/suites">balenaOS unmanaged testing suite</a>. To get the tests, clone the meta-balena repository. The OS tests are located in the <code>tests/</code> directory.</p>
				<ul>
					<li>Either copy the <code>OS test suite</code> directory from meta-balena to the <code>workspace</code> directory </li>
					<li>or point the <code>suite</code> property to the path of the OS test suite in the meta-balena directory.</li>
				</ul>
				<pre><code class="language-js"><span style="color: #DC3EB7">module</span><span style="color: #002339">.</span><span style="color: #DC3EB7">exports</span><span style="color: #002339"> </span><span style="color: #7B30D0">=</span><span style="color: #002339"> {</span>
<span style="color: #002339">     deviceType: </span><span style="color: #A44185">&quot;raspberrypi3&quot;</span><span style="color: #002339">,</span>
<span style="color: #002339">    suite: </span><span style="color: #A44185">`${</span><span style="color: #2F86D2">__dirname</span><span style="color: #A44185">}/../suites/os`</span><span style="color: #002339">, </span><span style="color: #357B42">// this path is relative to the workspace directory</span>
<span style="color: #002339">    config: {</span>
<span style="color: #002339">        networkWired: </span><span style="color: #174781">false</span><span style="color: #002339">,</span>
<span style="color: #002339">        networkWireless: </span><span style="color: #174781">true</span><span style="color: #002339">,</span>
<span style="color: #002339">        downloadVersion: </span><span style="color: #A44185">&#039;latest&#039;</span><span style="color: #002339">,</span>
<span style="color: #002339">        balenaApiKey: </span><span style="color: #2F86D2">process</span><span style="color: #002339">.</span><span style="color: #2F86D2">env</span><span style="color: #002339">.</span><span style="color: #2F86D2">BALENACLOUD_API_KEY</span><span style="color: #002339">,</span>
<span style="color: #002339">        balenaApiUrl: </span><span style="color: #A44185">&#039;balena-cloud.com&#039;</span><span style="color: #002339">,</span>
<span style="color: #002339">        organization: </span><span style="color: #2F86D2">process</span><span style="color: #002339">.</span><span style="color: #2F86D2">env</span><span style="color: #002339">.</span><span style="color: #2F86D2">BALENACLOUD_ORG</span><span style="color: #002339">,</span>
<span style="color: #002339">    },</span>
<span style="color: #002339">    image: </span><span style="color: #A44185">`${</span><span style="color: #2F86D2">__dirname</span><span style="color: #A44185">}/path/to/image`</span><span style="color: #002339">,</span>
<span style="color: #002339">    workers: {</span>
<span style="color: #002339">        balenaApplication: </span><span style="color: #A44185">&#039;your-fleet-slug&#039;</span><span style="color: #002339">,</span>
<span style="color: #002339">        apiKey: </span><span style="color: #2F86D2">process</span><span style="color: #002339">.</span><span style="color: #2F86D2">env</span><span style="color: #002339">.</span><span style="color: #2F86D2">BALENACLOUD_API_KEY</span>
<span style="color: #002339">    }</span>
<span style="color: #002339">};</span>
</code></pre>
				<ul>
					<li>This time you can provide your own OS image to test. You can download an unmanaged genericx86-64-ext balenaOS image from <a href="https://www.balena.io/os/#download">balena.io/os</a> and place it in the workspace folder if you need to provide one. Change the value of the <code>image</code> property to the path of the image you downloaded.</li>
				</ul>
				<a href="#start-the-os-test" id="start-the-os-test" style="color: inherit; text-decoration: none;">
					<h3>Start the OS test</h3>
				</a>
				<p>Run <code>make test</code> in the root of the project and watch the logs.</p>
				<p>The logs will start streaming on the terminal for the test run. At the end of the run, reports and logs for the test run will be stored in <code>workspace/reports</code> directory.</p>
				<p>That&#39;s the end of the quick start guide, you successfully setup your autokit worker and ran your first test suite.</p>
				<a href="#where-do-you-go-from-here" id="where-do-you-go-from-here" style="color: inherit; text-decoration: none;">
					<h2>Where do you go from here?</h2>
				</a>
				<ol>
					<li>Start by <a href="../writing-tests.html">writing your first test</a>.</li>
					<li>To know more about <code>config.js</code> and its properties, refer to <a href="../config-reference.html">Config.js reference</a>.</li>
					<li>To understand the bigger picture about the project read/watch these <a href="../learn-more.html">resources</a>.</li>
					<li>Some tips and references for <a href="../reference-tips.html">writing better tests</a> with Leviathan.</li>
					<li>Check out the source for tests that you ran, <a href="https://github.com/balena-os/leviathan/tree/master/suites">e2e test suite</a>.</li>
				</ol>
			</div>
		</div>
		<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
			<nav class="tsd-navigation primary">
				<ul>
					<li class="label pp-nav pp-group">
						<span>Getting-<wbr><wbr>Started</span>
					</li>
					<li class=" pp-nav pp-page pp-parent pp-active">
						<a href="../quickstart.html">Quickstart</a>
					</li>
					<li class="current pp-nav pp-page pp-child">
						<a href="quickstart-autokit.html">Autokit worker</a>
					</li>
					<li class=" pp-nav pp-page pp-child">
						<a href="quickstart-testbot.html">Testbot worker</a>
					</li>
					<li class=" pp-nav pp-page pp-child">
						<a href="quickstart-qemu.html">QEMU worker</a>
					</li>
					<li class=" pp-nav pp-page">
						<a href="../config-reference.html">Config.js <wbr>Reference</a>
					</li>
					<li class=" pp-nav pp-page">
						<a href="../writing-tests.html">Writing tests</a>
					</li>
					<li class=" pp-nav pp-page">
						<a href="../debugging.html">Debugging tests in <wbr>Leviathan</a>
					</li>
					<li class=" pp-nav pp-page">
						<a href="../reference-tips.html">Tips and <wbr>Reference</a>
					</li>
					<li class=" pp-nav pp-page">
						<a href="../learn-more.html">Links, and more links</a>
					</li>
					<li class="label pp-nav pp-group">
						<span>Helper <wbr>Methods</span>
					</li>
					<li class=" ">
						<a href="../../../modules.html">Modules</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/Archiver.html">Archiver</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/Context.html">Context</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/Graphics.html">Graphics</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/Leviathan_Utility_helpers.html">Leviathan <wbr>Utility helpers</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/Leviathan_Worker_helpers.html">Leviathan <wbr>Worker helpers</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/State.html">State</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/Suite.html">Suite</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/TaskQueue.html">Task<wbr>Queue</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/Test.html">Test</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/balenaCLI_helpers.html">balenaCLI helpers</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/balenaOS_helpers.html">balenaOS helpers</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="../../../modules/balenaSDK_helpers.html">balenaSDK helpers</a>
					</li>
				</ul>
			</nav>
			<nav class="tsd-navigation secondary menu-sticky">
				<ul class="before-current">
				</ul>
			</nav>
		</div>
	</div>
</div>
<footer class="with-border-bottom">
	<div class="container">
		<h2>Legend</h2>
		<div class="tsd-legend-group">
			<ul class="tsd-legend">
				<li class="tsd-kind-namespace"><span class="tsd-kind-icon">Namespace</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-class"><span class="tsd-kind-icon">Class</span></li>
			</ul>
		</div>
	</div>
</footer>
<div class="container tsd-generator">
	<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p>
</div>
<div class="overlay"></div>
<script src="../../../assets/js/main.js"></script>
<script>if (location.protocol == 'file:') document.write('<script src="../../../assets/js/search.json"><' + '/script>');</script>
</body>
</html>