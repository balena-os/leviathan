<!DOCTYPE html><html class="default" lang="en"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>quickstart-qemu | Leviathan</title><meta name="description" content="Documentation for Leviathan"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search" data-base=".."><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">Leviathan</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">Leviathan</a></li><li><a href="quickstart.html">quickstart</a></li><li><a href="quickstart.quickstart_qemu.html">quickstart-qemu</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="md:getting-started-with-qemu-worker" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Getting Started with QEMU Worker<a href="#md:getting-started-with-qemu-worker" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This is a quick start guide for using the Leviathan testing framework with a virtualized QEMU Device Under Test (DUT) called the QEMU worker. This workflow is particularly helpful for debugging, faster tester runs than actual hardware or if you don't have hardware on hand.</p>
<p>Before beginning, make sure you completed the Leviathan pre-requisted listed on the <a href="quickstart.html">Quickstart Page</a>.</p>
<a id="md:start-your-first-test-run" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Start your first test run<a href="#md:start-your-first-test-run" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>For your first test run, we will be running the <a href="https://github.com/balena-os/leviathan/tree/master/suites/e2e" target="_blank" class="external">e2e test suite</a>. This is a basic testing suite to test your worker configuration and if the setup is correct. Each Levaithan test run needs the following to start testing that the user has to provide:</p>
<ol>
<li><strong>The test suite you want to run</strong>: <a href="https://github.com/balena-os/leviathan/tree/master/suites/e2e" target="_blank" class="external">e2e test suite</a> (already provided)</li>
<li><strong>A balenaOS image used to flash, provision and test the DUT</strong>. The test will automatically download an OS image this time. So no need to provide your own image.</li>
<li>To run QEMU tests, we need the TUN interface. Run the following commands to activate the TUN module.</li>
</ol>
<pre><code><span class="hl-7">sudo</span><span class="hl-1"> </span><span class="hl-7">modprobe</span><span class="hl-1"> </span><span class="hl-7">tun</span>
</code><button>Copy</button></pre>

<ol start="4">
<li><strong>A test configuration using the <code>config.js</code> file</strong>: Let's create one.</li>
</ol>
<a id="md:build-your-configjs-file" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Build your <code>config.js</code> file<a href="#md:build-your-configjs-file" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The config.js file is the master configuration file for your test runs in leviathan. The QEMU worker spins up and configures your device under test (DUT) according to the settings provided in the <code>config.js</code> file. To know more about each property, refer to the <a href="config_reference.html">Config.js reference</a>.</p>
<p>Create your own config.js file</p>
<ul>
<li>Navigate to the <code>workspace</code> directory in leviathan.</li>
<li>Create a <code>config.js</code> file in the <code>workspace</code> directory and paste the contents below.</li>
</ul>
<pre><code class="js"><span class="hl-4">module</span><span class="hl-1">.</span><span class="hl-4">exports</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">deviceType:</span><span class="hl-1"> </span><span class="hl-2">&#39;genericx86-64-ext&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">suite:</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-7">__dirname</span><span class="hl-6">}</span><span class="hl-2">/../suites/e2e`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">config:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">networkWired:</span><span class="hl-1"> </span><span class="hl-8">false</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">networkWireless:</span><span class="hl-1"> </span><span class="hl-8">false</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">downloadVersion:</span><span class="hl-1"> </span><span class="hl-2">&#39;latest&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">balenaApiKey:</span><span class="hl-1"> </span><span class="hl-7">process</span><span class="hl-1">.</span><span class="hl-7">env</span><span class="hl-1">.</span><span class="hl-9">BALENACLOUD_API_KEY</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">balenaApiUrl:</span><span class="hl-1"> </span><span class="hl-2">&#39;balena-cloud.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">organization:</span><span class="hl-1"> </span><span class="hl-7">process</span><span class="hl-1">.</span><span class="hl-7">env</span><span class="hl-1">.</span><span class="hl-9">BALENACLOUD_ORG</span><span class="hl-1">,</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-5">debug:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">unstable:</span><span class="hl-1"> [</span><span class="hl-2">&quot;Kill the device under test&quot;</span><span class="hl-1">],</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-5">image:</span><span class="hl-1"> </span><span class="hl-8">false</span><span class="hl-1">, </span><br/><span class="hl-1">    </span><span class="hl-5">workers:</span><span class="hl-1"> [</span><span class="hl-2">&#39;http://worker&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>Ensure that you fill all fields in the <code>config.js</code> file before proceeding. Refer to the <a href="config_reference.html">Config.js reference</a> for more information</p>
<p>You can either modify the <code>config.js</code> file or provide values using environment variables. To provide values of environment variables easily, you can create a <code>.env</code> file in the root of the leviathan directory. Use the format below as boilerplate.</p>
<pre><code class="bash"><span class="hl-7">WORKSPACE</span><span class="hl-3">=</span><span class="hl-2">./workspace</span><br/><span class="hl-7">REPORTS</span><span class="hl-3">=</span><span class="hl-2">./workspace/reports</span><br/><span class="hl-7">SUITES</span><span class="hl-3">=</span><span class="hl-2">/path/to/suites</span><br/><span class="hl-7">DEVICE_TYPE</span><span class="hl-3">=</span><span class="hl-2">intel-nuc</span><br/><span class="hl-7">WORKER_TYPE</span><span class="hl-3">=</span><span class="hl-2">qemu</span><br/><span class="hl-7">BALENACLOUD_API_KEY</span><span class="hl-3">=</span><span class="hl-2">SAMPLEKEYuhfuwehfewiuf[...</span><span class="hl-1">]LLJA</span><br/><span class="hl-7">BALENACLOUD_ORG</span><span class="hl-3">=</span><span class="hl-2">g_username_of_the_user</span>
</code><button type="button">Copy</button></pre>

<p>Refer to the <a href="config_reference.html">Environment Variables Reference</a> for more values you can specify.</p>
<a id="md:start-the-run" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Start the run<a href="#md:start-the-run" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>To start the test run, navigate to the root of the Leviathan directory and run the following command:</p>
<pre><code><span class="hl-7">make</span><span class="hl-1"> </span><span class="hl-7">local</span><span class="hl-3">-</span><span class="hl-7">test</span>
</code><button>Copy</button></pre>

<p>This will trigger a build of client and core services using docker-compose and begin the test. The logs by various componenet will start streaming on the terminal. Wait for the test scenario to finish and check the device logs on the dashboard in the meantime.</p>
<blockquote>
<p>Refer to <a href="debugging.html">FAQ's for common issues mentioned below and debug your test setup</a></p>
</blockquote>
<p>A successful run of the e2e test suite without any errors makes sure that your QEMU worker is set up correctly and can be used for further tests.</p>
<a id="md:lets-run-some-real-tests" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Let's run some &quot;real&quot; tests<a href="#md:lets-run-some-real-tests" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>We will start with a test run of the <a href="https://github.com/balena-os/meta-balena/tree/master/tests/suites" target="_blank" class="external">balenaOS unmanaged testing suite</a>. To get the tests, clone the <a href="https://github.com/balena-os/meta-balena/" target="_blank" class="external">meta-balena</a> repository. The OS tests are located in the <code>tests/suites/</code> directory.</p>
<ul>
<li>Either copy the <code>OS</code> test suite directory from meta-balena to the <code>suites</code> directory</li>
<li>or point the <code>suite</code> property in your config.js file to the relative path of the OS test suite like mentioned below.</li>
</ul>
<pre><code class="js"><span class="hl-4">module</span><span class="hl-1">.</span><span class="hl-4">exports</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">deviceType:</span><span class="hl-1"> </span><span class="hl-2">&#39;genericx86-64-ext&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">suite:</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-7">__dirname</span><span class="hl-6">}</span><span class="hl-2">/../suites/os`</span><span class="hl-1">, </span><span class="hl-11">// this path is relative to the workspace directory</span><br/><span class="hl-1">    </span><span class="hl-5">config:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">networkWired:</span><span class="hl-1"> </span><span class="hl-8">false</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">networkWireless:</span><span class="hl-1"> </span><span class="hl-8">false</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">downloadVersion:</span><span class="hl-1"> </span><span class="hl-2">&#39;latest&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">balenaApiKey:</span><span class="hl-1"> </span><span class="hl-7">process</span><span class="hl-1">.</span><span class="hl-7">env</span><span class="hl-1">.</span><span class="hl-9">BALENACLOUD_API_KEY</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">balenaApiUrl:</span><span class="hl-1"> </span><span class="hl-2">&#39;balena-cloud.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">organization:</span><span class="hl-1"> </span><span class="hl-2">&#39;BALENACLOUD_ORG_GOES_HERE&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-5">image:</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-7">__dirname</span><span class="hl-6">}</span><span class="hl-2">/path/to/image`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">workers:</span><span class="hl-1"> [</span><span class="hl-2">&#39;http://worker&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>This time you can provide your own OS image to test. You can download an unmanaged genericx86-64-ext balenaOS image from <a href="https://www.balena.io/os/#download" target="_blank" class="external">balena.io/os</a> and place it in the <code>workspace</code> directory. Change the value of the <code>image</code> property to the path of the image you downloaded. This will be the OS image used by the OS tests in Leviathan.</p>
<a id="md:start-the-os-test" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Start the OS test<a href="#md:start-the-os-test" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Run <code>make local-test</code> in the root of the project and watch the logs.</p>
<p>The logs will start streaming on the terminal for the test run. At the end of the run, reports and logs for the test run will be stored in <code>workspace/reports</code> directory.</p>
<p>That's the end of the quick start guide, you successfully setup your QEMU worker and ran your first test suite.</p>
<a id="md:where-do-you-go-from-here" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Where do you go from here?<a href="#md:where-do-you-go-from-here" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ol>
<li>Start by <a href="writing_tests.html">writing your first test</a>.</li>
<li>To know more about <code>config.js</code> and its properties, refer to <a href="config_reference.html">Config.js reference</a>.</li>
<li>To understand the bigger picture about the project read/watch these <a href="learn_more.html">resources</a>.</li>
<li>Some tips and references for <a href="reference_tips.html">writing better tests</a> with Leviathan.</li>
<li>Check out the source for tests that you ran, <a href="https://github.com/balena-os/leviathan/tree/master/suites" target="_blank" class="external">e2e test suite</a>.</li>
</ol>
<a id="md:advanced" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Advanced<a href="#md:advanced" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Worker configuration variables can be specified in <code>docker-compose.qemu.yml</code>, under <code>environment</code>. The default configuration should suffice in most cases.</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>QEMU_ARCH</td>
<td>Architecture to virtualize (default: x86_64)</td>
</tr>
<tr>
<td>QEMU_CPUS</td>
<td>Number of CPUs to virtualize (default: 4)</td>
</tr>
<tr>
<td>QEMU_MEMORY</td>
<td>Amount of memory to virtualize (default: 2G)</td>
</tr>
<tr>
<td>QEMU_BRIDGE_NAME</td>
<td>Name of bridge to use for networking (default: br0)</td>
</tr>
<tr>
<td>QEMU_BRIDGE_ADDRESS</td>
<td>IP address to assign to bridge</td>
</tr>
<tr>
<td>QEMU_DHCP_RANGE</td>
<td>Range of DHCP addresses to hand out to workers</td>
</tr>
</tbody>
</table>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#md:getting-started-with-qemu-worker"><span>Getting <wbr/>Started with QEMU <wbr/>Worker</span></a><ul><li><a href="#md:start-your-first-test-run"><span>Start your first test run</span></a></li><li><ul><li><a href="#md:build-your-configjs-file"><span>Build your config.js file</span></a></li><li><a href="#md:start-the-run"><span>Start the run</span></a></li></ul></li><li><a href="#md:lets-run-some-real-tests"><span>Let&#39;s run some &quot;real&quot; tests</span></a></li><li><ul><li><a href="#md:start-the-os-test"><span>Start the OS test</span></a></li></ul></li><li><a href="#md:where-do-you-go-from-here"><span>Where do you go from here?</span></a></li><li><a href="#md:advanced"><span>Advanced</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-1"></use></svg><span>Leviathan</span></a><ul class="tsd-small-nested-navigation" id="tsd-nav-container" data-base=".."><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
