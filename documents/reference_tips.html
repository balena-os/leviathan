<!DOCTYPE html><html class="default" lang="en"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>reference-tips | Leviathan</title><meta name="description" content="Documentation for Leviathan"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search" data-base=".."><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">Leviathan</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">Leviathan</a></li><li><a href="reference_tips.html">reference-tips</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="md:tips-for-writing-tests-and-reference-guide" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Tips for writing tests and reference guide<a href="#md:tips-for-writing-tests-and-reference-guide" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="md:worker" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Worker<a href="#md:worker" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The worker class can be used to control the testbot hardware. In the <code>suite.js</code> file, you can create an instance of it, and then use its methods to flash the DUT, power it on/off, and set up a network AP for the DUT to connect to.</p>
<pre><code class="js"><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">Worker</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-2">&#39;common/worker&#39;</span><span class="hl-1">);</span><br/><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">suite</span><span class="hl-1">.</span><span class="hl-7">context</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">({</span><br/><span class="hl-1">	</span><span class="hl-5">worker:</span><span class="hl-1"> </span><span class="hl-17">new</span><span class="hl-1"> </span><span class="hl-0">Worker</span><span class="hl-1">(</span><span class="hl-9">DEVICE_TYPE_SLUG</span><span class="hl-1">, </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">getLogger</span><span class="hl-1">()), </span><span class="hl-11">// Add an instance of worker to the context</span><br/><span class="hl-1">});</span><br/><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">Worker</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-2">&#39;common/worker&#39;</span><span class="hl-1">);</span><br/><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">worker</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-17">new</span><span class="hl-1"> </span><span class="hl-0">Worker</span><span class="hl-1">(</span><span class="hl-9">DEVICE_TYPE_SLUG</span><span class="hl-1">, </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">getLogger</span><span class="hl-1">())</span>
</code><button type="button">Copy</button></pre>

<p>The <code>this.getLogger()</code> method gets the logger that can be used from any suite.
Once you have an instance of the`Worker class, you can use its methods like this:</p>
<pre><code class="js"><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">Worker</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-2">&#39;common/worker&#39;</span><span class="hl-1">);</span><br/><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">worker</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-17">new</span><span class="hl-1"> </span><span class="hl-0">Worker</span><span class="hl-1">(</span><span class="hl-9">DEVICE_TYPE_SLUG</span><span class="hl-1">, </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">getLogger</span><span class="hl-1">())</span><br/><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-7">worker</span><span class="hl-1">.</span><span class="hl-0">network</span><span class="hl-1">(</span><span class="hl-7">network</span><span class="hl-1">: {</span><br/><span class="hl-1">	</span><span class="hl-5">ssid:</span><span class="hl-1"> </span><span class="hl-9">SSID</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">psk:</span><span class="hl-1"> </span><span class="hl-9">PASSWORD</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">nat:</span><span class="hl-1"> </span><span class="hl-8">true</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-7">worker</span><span class="hl-1">.</span><span class="hl-0">off</span><span class="hl-1">() </span><span class="hl-11">// turn off the power to the DUT</span><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-7">worker</span><span class="hl-1">.</span><span class="hl-0">flash</span><span class="hl-1">() </span><span class="hl-11">// flash the DUT</span><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-7">worker</span><span class="hl-1">.</span><span class="hl-0">on</span><span class="hl-1">()</span>
</code><button type="button">Copy</button></pre>

<p>Another helpful method of the worker is <code>executeCommandInHostOs</code>, which lets you execute command line operations in the host OS of the DUT.
Assuming that the DUT is connected to the AP of the testbot:</p>
<pre><code class="js"><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">Worker</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-2">&#39;common/worker&#39;</span><span class="hl-1">);</span><br/><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">worker</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-17">new</span><span class="hl-1"> </span><span class="hl-0">Worker</span><span class="hl-1">(</span><span class="hl-9">DEVICE_TYPE_SLUG</span><span class="hl-1">, </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">getLogger</span><span class="hl-1">())</span><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-7">worker</span><span class="hl-1">.</span><span class="hl-0">executeCommandInHostOS</span><span class="hl-1">(</span><span class="hl-2">&#39;cat /etc/hostname&#39;</span><span class="hl-1">, </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-9">UUID</span><span class="hl-6">}</span><span class="hl-2">.local`</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="md:context" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Context<a href="#md:context" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The context class lets you share instances of objects across different tests. For example, if we made an instance of the worker class in a suite, as above, other tests would not be able to see it. An instance of the context class has a <code>set()</code> and a <code>get()</code> method, to both add or fetch objects from the context. An example can be seen below:</p>
<pre><code class="js"><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">Worker</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-2">&#39;common/worker&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">suite</span><span class="hl-1">.</span><span class="hl-7">context</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">({</span><br/><span class="hl-1">	</span><span class="hl-5">worker:</span><span class="hl-1"> </span><span class="hl-17">new</span><span class="hl-1"> </span><span class="hl-0">Worker</span><span class="hl-1">(</span><span class="hl-9">DEVICE_TYPE_SLUG</span><span class="hl-1">, </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">getLogger</span><span class="hl-1">()), </span><span class="hl-11">// Add an instance of worker to the context</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">context</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">().</span><span class="hl-7">worker</span><span class="hl-1">.</span><span class="hl-0">flash</span><span class="hl-1">() </span><span class="hl-11">// flash the DUT with the worker instance thats in the context</span>
</code><button type="button">Copy</button></pre>

<p>The context can be used to share anything between tests - device uuids, app names and so on.</p>
<a id="md:os-helpers" class="tsd-anchor"></a><h3 class="tsd-anchor-link">OS helpers<a href="#md:os-helpers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>BalenaOS</code> helper class can be used to configure and unpack the OS image that you will use in the test. This allows you to inject config options and network credentials into your image.</p>
<pre><code class="js"><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">network_conf</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-5">ssid:</span><span class="hl-1"> </span><span class="hl-9">SSID</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">psk:</span><span class="hl-1"> </span><span class="hl-9">PASSWORD</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">nat:</span><span class="hl-1"> </span><span class="hl-8">true</span><span class="hl-1">,</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">os</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-17">new</span><span class="hl-1"> </span><span class="hl-0">BalenaOS</span><span class="hl-1">(</span><br/><span class="hl-1">	{</span><br/><span class="hl-1">		</span><span class="hl-5">deviceType:</span><span class="hl-1"> </span><span class="hl-9">DEVICE_TYPE_SLUG</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">network:</span><span class="hl-1"> </span><span class="hl-7">network_conf</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">configJson:</span><span class="hl-1"> {</span><br/><span class="hl-1">			</span><span class="hl-5">uuid:</span><span class="hl-1"> </span><span class="hl-9">UUID</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-5">persistentLogging:</span><span class="hl-1"> </span><span class="hl-8">true</span><span class="hl-1">,</span><br/><span class="hl-1">		},</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">	</span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">getLogger</span><span class="hl-1">(),</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-7">os</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">();</span><br/><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-7">os</span><span class="hl-1">.</span><span class="hl-0">configure</span><span class="hl-1">()</span>
</code><button type="button">Copy</button></pre>

<p>Alternatively, you can use the CLI to perform these functions - the CLI is imported in the testing environment:</p>
<pre><code class="js"><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-0">exec</span><span class="hl-1">(</span><span class="hl-2">`balena login --token </span><span class="hl-6">${</span><span class="hl-9">API_KEY</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-0">exec</span><span class="hl-1">(</span><br/><span class="hl-1">	</span><span class="hl-2">`balena os configure </span><span class="hl-6">${</span><span class="hl-9">PATH_TO_IMAGE</span><span class="hl-6">}</span><span class="hl-2">-a </span><span class="hl-6">${</span><br/><span class="hl-18">	</span><span class="hl-6">}</span><span class="hl-2"> --config-network wifi --config-wifi-key </span><span class="hl-6">${</span><br/><span class="hl-18">		</span><span class="hl-9">PASSWORD</span><br/><span class="hl-18">	</span><span class="hl-6">}</span><span class="hl-2">  --config-wifi-ssid </span><span class="hl-6">${</span><br/><span class="hl-18">		</span><span class="hl-9">SSID</span><br/><span class="hl-18">	</span><span class="hl-6">}</span><span class="hl-2">  `</span><span class="hl-1">,</span><br/><span class="hl-1">); </span>
</code><button type="button">Copy</button></pre>

<a id="md:cloud-helpers" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Cloud helpers<a href="#md:cloud-helpers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>BalenaSDK</code> class, defined in <a href="https://github.com/balena-os/leviathan/blob/master/core/lib/components/balena/sdk.js" target="_blank" class="external"><code>core/components/balena/sdk</code></a>, contains an instance of the balena sdk, as well as some helper methods. The <code>balena</code> attribute of the class contains the sdk, which can then be used as follows:</p>
<pre><code class="js"><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">Cloud</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-2">&quot;components/balena/sdk&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">suite</span><span class="hl-1">.</span><span class="hl-7">context</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">({</span><br/><span class="hl-1">	</span><span class="hl-5">cloud:</span><span class="hl-1"> </span><span class="hl-17">new</span><span class="hl-1"> </span><span class="hl-0">Balena</span><span class="hl-1">(</span><span class="hl-2">`https://api.balena-cloud.com/`</span><span class="hl-1">, </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">getLogger</span><span class="hl-1">())</span><br/><span class="hl-1">});</span><br/><br/><br/><span class="hl-11">// login</span><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">context</span><br/><span class="hl-1">	.</span><span class="hl-0">get</span><span class="hl-1">()</span><br/><span class="hl-1">	.</span><span class="hl-7">cloud</span><span class="hl-1">.</span><span class="hl-7">balena</span><span class="hl-1">.</span><span class="hl-7">auth</span><span class="hl-1">.</span><span class="hl-0">loginWithToken</span><span class="hl-1">(</span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">suite</span><span class="hl-1">.</span><span class="hl-7">options</span><span class="hl-1">.</span><span class="hl-7">balena</span><span class="hl-1">.</span><span class="hl-7">apiKey</span><span class="hl-1">);</span><br/><br/><span class="hl-11">// create a balena application</span><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">context</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">().</span><span class="hl-7">cloud</span><span class="hl-1">.</span><span class="hl-7">balena</span><span class="hl-1">.</span><span class="hl-7">models</span><span class="hl-1">.</span><span class="hl-7">application</span><span class="hl-1">.</span><span class="hl-0">create</span><span class="hl-1">({</span><br/><span class="hl-1">	</span><span class="hl-5">name:</span><span class="hl-1"> </span><span class="hl-2">`NAME`</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">deviceType:</span><span class="hl-1"> </span><span class="hl-2">`DEVICE_TYPE`</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">organization:</span><span class="hl-1"> </span><span class="hl-2">`ORG`</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/>
</code><button type="button">Copy</button></pre>

<p>Alternatively, Balena SDK is imported into the testing environment by default, so you can create an instance of the SDK and use it without the cloud helpers class:</p>
<pre><code class="js"><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">suite</span><span class="hl-1">.</span><span class="hl-7">context</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">({</span><br/><span class="hl-1">	</span><span class="hl-5">balena:</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-5">sdk:</span><span class="hl-1"> </span><span class="hl-0">getSdk</span><span class="hl-1">({</span><br/><span class="hl-1">			</span><span class="hl-5">apiUrl:</span><span class="hl-1"> </span><span class="hl-2">&#39;https://api.balena-cloud.com/&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">		}),</span><br/><span class="hl-1">		</span><span class="hl-5">sshKey:</span><span class="hl-1"> { </span><span class="hl-5">label:</span><span class="hl-1"> </span><span class="hl-9">LABEL</span><span class="hl-1">},</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">context</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">().</span><span class="hl-7">balena</span><span class="hl-1">.</span><span class="hl-7">sdk</span><span class="hl-1">.</span><span class="hl-7">auth</span><span class="hl-1">.</span><span class="hl-0">loginWithToken</span><span class="hl-1">(</span><span class="hl-9">TOKEN</span><span class="hl-1">);</span><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">context</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">().</span><span class="hl-7">balena</span><span class="hl-1">.</span><span class="hl-7">sdk</span><span class="hl-1">.</span><span class="hl-7">models</span><span class="hl-1">.</span><span class="hl-7">application</span><span class="hl-1">.</span><span class="hl-0">create</span><span class="hl-1">({</span><br/><span class="hl-1">	</span><span class="hl-5">name:</span><span class="hl-1"> </span><span class="hl-9">APP_NAME</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">deviceType:</span><span class="hl-1"> </span><span class="hl-9">DEVICE_TYPE_SLUG</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">organization:</span><span class="hl-1"> </span><span class="hl-9">ORG</span><span class="hl-1">,</span><br/><span class="hl-1">})</span>
</code><button type="button">Copy</button></pre>

<a id="md:suite-node-dependencies" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Suite node dependencies<a href="#md:suite-node-dependencies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each suite also has its own <code>package.json</code> that can be used to list dependencies for any tests in that suite, if those packages aren'y already present within the testing environment.</p>
<a id="md:teardowns" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Teardowns<a href="#md:teardowns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>You can register functions to be carried out upon &quot;teardown&quot; of the suite or test. These will execute when the test ends, regardless of passing or failing:</p>
<pre><code class="js"><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">suite</span><span class="hl-1">.</span><span class="hl-7">teardown</span><span class="hl-1">.</span><span class="hl-0">register</span><span class="hl-1">(() </span><span class="hl-15">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;Worker teardown&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-13">return</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">context</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">().</span><span class="hl-7">worker</span><span class="hl-1">.</span><span class="hl-0">teardown</span><span class="hl-1">();</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>If registered in the suite, this will be carried out upon the suite (the collection of tests) ending. You can also add individual teardowns within tests, that will execute when the individual test has ended. In this example here, within the test, we create an applciation, and after the test, we wish to remove that application:</p>
<pre><code class="js"><span class="hl-4">module</span><span class="hl-1">.</span><span class="hl-4">exports</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-5">title:</span><span class="hl-1"> </span><span class="hl-2">&#39;Example&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">tests:</span><span class="hl-1"> [</span><br/><span class="hl-1">			{</span><br/><span class="hl-1">				</span><span class="hl-5">title:</span><span class="hl-1"> </span><span class="hl-2">&#39;Move device to another application&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">				</span><span class="hl-0">run</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-19">async</span><span class="hl-1"> </span><span class="hl-15">function</span><span class="hl-1">(</span><span class="hl-20">test</span><span class="hl-1">) {</span><br/><span class="hl-1">					</span><span class="hl-11">// create an app</span><br/><span class="hl-1">					</span><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">context</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">().</span><span class="hl-7">balena</span><span class="hl-1">.</span><span class="hl-7">sdk</span><span class="hl-1">.</span><span class="hl-7">models</span><span class="hl-1">.</span><span class="hl-7">application</span><span class="hl-1">.</span><span class="hl-0">create</span><span class="hl-1">({</span><br/><span class="hl-1">						</span><span class="hl-5">name:</span><span class="hl-1"> </span><span class="hl-9">APP</span><span class="hl-1">,</span><br/><span class="hl-1">						</span><span class="hl-5">deviceType:</span><span class="hl-1"> </span><span class="hl-9">DEVICE_TYPE</span><span class="hl-1">,</span><br/><span class="hl-1">						</span><span class="hl-5">organization:</span><span class="hl-1"> </span><span class="hl-9">ORG</span><span class="hl-1">,</span><br/><span class="hl-1">					});</span><br/><span class="hl-1">					</span><span class="hl-11">// Register a teardown that will remove the test when the test ends</span><br/><span class="hl-1">					</span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">teardown</span><span class="hl-1">.</span><span class="hl-0">register</span><span class="hl-1">(() </span><span class="hl-15">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">						</span><span class="hl-13">return</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">context</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">().</span><span class="hl-7">balena</span><span class="hl-1">.</span><span class="hl-7">sdk</span><span class="hl-1">.</span><span class="hl-7">models</span><span class="hl-1">.</span><span class="hl-7">application</span><span class="hl-1">.</span><span class="hl-0">remove</span><span class="hl-1">(</span><span class="hl-9">APP</span><span class="hl-1">);</span><br/><span class="hl-1">					});</span><br/><br/><span class="hl-1">					</span><span class="hl-11">// THE REST OF THE TEST CODE</span><br/><span class="hl-1">				}</span><br/><span class="hl-1">			}</span><br/><span class="hl-1">		]</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="md:screen-capture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Screen capture<a href="#md:screen-capture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If screen capture is supported and appropriate hardware is attached, the video output of the DUT can be captured. For the testbot, this requires a compatible video capture device to be connected, that works with v4L2 and enumerates on the <code>/dev/video0</code> interface.</p>
<p>If that is the case, then capture can be started using the <code>Worker</code> class <code>capture()</code> method, for example:</p>
<pre><code class="js"><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">Worker</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-2">&#39;common/worker&#39;</span><span class="hl-1">);</span><br/><span class="hl-15">const</span><span class="hl-1"> </span><span class="hl-9">worker</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> </span><span class="hl-17">new</span><span class="hl-1"> </span><span class="hl-0">Worker</span><span class="hl-1">(</span><span class="hl-2">&#39;DEVICE_TYPE_SLUG&#39;</span><span class="hl-1">, </span><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-0">getLogger</span><span class="hl-1">())</span><br/><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-7">worker</span><span class="hl-1">.</span><span class="hl-0">capture</span><span class="hl-1">(</span><span class="hl-2">&#39;start&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This will trigger video capture to start, and frames will be saved as <code>jpg</code> files in the <code>/data/capture</code> directory (which is a shared volume). Capture will continue until stopped with:</p>
<pre><code class="js"><span class="hl-13">await</span><span class="hl-1"> </span><span class="hl-7">worker</span><span class="hl-1">.</span><span class="hl-0">capture</span><span class="hl-1">(</span><span class="hl-2">&#39;stop&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="md:sending-reports-and-artifacts-back-to-the-client-from-the-testbot" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Sending reports and artifacts back to the client from the testbot<a href="#md:sending-reports-and-artifacts-back-to-the-client-from-the-testbot" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>By default, serial logs (given that the hardware is set up correctly), and the logs from the tests will be sent back to the client that started the test, upon the test finishing. Other artifacts can be sent back to the client using the <code>archiver</code> method. This method is available within any test:</p>
<pre><code class="js"><span class="hl-16">this</span><span class="hl-1">.</span><span class="hl-7">archiver</span><span class="hl-1">.</span><span class="hl-0">add</span><span class="hl-1">(</span><span class="hl-2">`FILE OR DIRECTORY`</span><span class="hl-1">)</span>
</code><button type="button">Copy</button></pre>

<p>Using this method, at the end of the test, any artifacts added to the archive are compressed and downloaded by the client. These are available in the <code>workspace/reports</code> directory at the end of the test.</p>
<a id="md:what-should-go-in-the-suitejs-of-a-suite" class="tsd-anchor"></a><h3 class="tsd-anchor-link">What should go in the suite.js of a suite<a href="#md:what-should-go-in-the-suitejs-of-a-suite" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The recommended pattern is to put the code that gets the device into the state ready for the tests, into the suite.
Usually, this will include:</p>
<ul>
<li>creating an instance of the worker class</li>
<li>configuring the OS image with the correct configuration and network settings</li>
<li>setting up the network of the testbot (using <code>Worker.network()</code>)</li>
<li>flashing the DUT (using <code>Worker.flash()</code>)</li>
<li>Checking that the device is online</li>
<li>listing the tests</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#md:tips-for-writing-tests-and-reference-guide"><span>Tips for writing tests and reference guide</span></a><ul><li><a href="#md:worker"><span>Worker</span></a></li><li><a href="#md:context"><span>Context</span></a></li><li><a href="#md:os-helpers"><span>OS helpers</span></a></li><li><a href="#md:cloud-helpers"><span>Cloud helpers</span></a></li><li><a href="#md:suite-node-dependencies"><span>Suite node dependencies</span></a></li><li><a href="#md:teardowns"><span>Teardowns</span></a></li><li><a href="#md:screen-capture"><span>Screen capture</span></a></li><li><a href="#md:sending-reports-and-artifacts-back-to-the-client-from-the-testbot"><span>Sending reports and artifacts back to the client from the testbot</span></a></li><li><a href="#md:what-should-go-in-the-suitejs-of-a-suite"><span>What should go in the suite.js of a suite</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-1"></use></svg><span>Leviathan</span></a><ul class="tsd-small-nested-navigation" id="tsd-nav-container" data-base=".."><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
