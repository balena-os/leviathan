<!DOCTYPE html><html class="default" lang="en"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>writing-tests | Leviathan</title><meta name="description" content="Documentation for Leviathan"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search" data-base=".."><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">Leviathan</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">Leviathan</a></li><li><a href="writing_tests.html">writing-tests</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="md:writing-new-tests-in-leviathan" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Writing new tests in Leviathan<a href="#md:writing-new-tests-in-leviathan" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>The leviathan framework runs 'suites'. A suite is a collection of tests and a configuration for the environment. The current suite that runs on meta-balena &amp; balena-raspberrypi PRs can be found <a href="https://github.com/balena-os/meta-balena/tree/master/tests/suites/os" target="_blank" class="external">here on GitHub</a>.</p>
<p>Leviathan comprises a client, which sends test suites, and a testbot, which will listen for and execute suites. The client is a container that you can run on your laptop, or within an automated workflow to send tests to a testbot.</p>
<p>As you can see from the linked meta-balena directory, we can set up a directory containing a test suite as follows:</p>
<ul>
<li><code>tests</code> - Folder containing actual tests</li>
<li><code>conf.js</code> - File assigning configuration options</li>
<li><code>package.json</code> - File containing the node dependencies to install for the test suite</li>
<li><code>suite.js</code> - File where you can select what tests are run as part of the suite, and define your setup code to run before the tests start.</li>
</ul>
<p>Inside the tests folder, you can add the actual test logic. The recommended approach is to add a folder for each test (with an appropriate name), and inside, keep any assets associated with the test. The test can be written within a file called <code>index.js</code>. The tests folder will look something like:</p>
<pre><code class="bash"><span class="hl-0">-</span><span class="hl-1"> </span><span class="hl-2">tests</span><br/><span class="hl-1">    </span><span class="hl-0">-</span><span class="hl-1"> </span><span class="hl-2">test-1</span><br/><span class="hl-1">        </span><span class="hl-0">-</span><span class="hl-1"> </span><span class="hl-2">assets</span><br/><span class="hl-1">        </span><span class="hl-0">-</span><span class="hl-1"> </span><span class="hl-2">index.js</span><span class="hl-1"> </span><span class="hl-2">-</span><span class="hl-1"> </span><span class="hl-2">the</span><span class="hl-1"> </span><span class="hl-2">test</span><span class="hl-1"> </span><span class="hl-2">is</span><span class="hl-1"> </span><span class="hl-2">written</span><span class="hl-1"> </span><span class="hl-2">in</span><span class="hl-1"> </span><span class="hl-2">this</span><span class="hl-1"> </span><span class="hl-2">file</span><br/><span class="hl-1">    </span><span class="hl-0">-</span><span class="hl-1"> </span><span class="hl-2">test-2</span><br/><span class="hl-1">        </span><span class="hl-0">-</span><span class="hl-1"> </span><span class="hl-2">assets</span><br/><span class="hl-1">        </span><span class="hl-0">-</span><span class="hl-1"> </span><span class="hl-2">index.js</span><br/><span class="hl-1">    </span><span class="hl-0">-</span><span class="hl-1"> </span><span class="hl-2">.</span><br/><span class="hl-1">    </span><span class="hl-0">-</span><span class="hl-1"> </span><span class="hl-2">.</span><br/><span class="hl-1">    </span><span class="hl-0">-</span><span class="hl-1"> </span><span class="hl-2">etc</span><span class="hl-1"> </span>
</code><button type="button">Copy</button></pre>

<a id="md:how-do-i-add-a-new-test" class="tsd-anchor"></a><h2 class="tsd-anchor-link">How do I add a new test?<a href="#md:how-do-i-add-a-new-test" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>To add a new test, you could either create a new suite, or a add a test to an existing suite.
For reference, an old PR <a href="https://github.com/balena-os/leviathan/commit/0ec26632881ef2c262e67d30ebccaaf0611b01ad#diff-df7b8717d54947445c5900174e15e5cf" target="_blank" class="external">adding a test</a> to the OS test suite in Leviathan.</p>
<a id="md:adding-a-testtests-to-an-existing-suite" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Adding a test/tests to an existing suite<a href="#md:adding-a-testtests-to-an-existing-suite" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>Navigate to the suite folder where the test needs to be added (for example <a href="https://github.com/balena-os/meta-balena/tree/master/tests/suites/os" target="_blank" class="external">https://github.com/balena-os/meta-balena/tree/master/tests/suites/os</a>).</li>
<li>Navigate to the <code>/tests</code> directory inside that suite.</li>
<li>Create a new directory <code>&lt;MY_NEw_TEST&gt;</code>, with an appropriate name for your test.</li>
<li>Inside this new directory, create an <code>index.js</code> file</li>
<li>Inside <code>index.js</code>, test logic lives (details about writing the test logic are explained in the next section)</li>
<li>Going back to the suite directory, navigate to <code>suite.js</code></li>
<li>Inside <code>suite.js</code>, towards the botton of the file, there will be an array named <code>tests</code>, add your new test to it like this:</li>
</ol>
<pre><code class="js"><span class="hl-10">tests</span><span class="hl-1">: [</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;./tests/fingerprint&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;./tests/led&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;./tests/config-json&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;./tests/connectivity&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;./tests/&lt;MY_NEw_TEST&gt;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    ],</span>
</code><button type="button">Copy</button></pre>

<ol start="8">
<li>Ensure that any new dependencies used in your test are added to the <code>package.json</code></li>
</ol>
<a id="md:writing-the-test-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Writing the test logic<a href="#md:writing-the-test-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Tests must be written in node, and are ingested by a framework called <a href="https://node-tap.org/docs/api/asserts/" target="_blank" class="external">node-tap</a>.
To write a new test, inside <code>tests/&lt;MY_NEw_TEST&gt;/index.js</code> , we can use the following template (note that this file can contain a set of tests - you just have to have multiple objects in the <code>tests</code> array!)</p>
<p>Each test is an asychnronous function, assigned to the <code>run</code> attribute of a test.</p>
<pre><code class="js"><span class="hl-2">&#39;use strict&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">module</span><span class="hl-1">.</span><span class="hl-4">exports</span><span class="hl-1"> </span><span class="hl-3">=</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">title:</span><span class="hl-1"> </span><span class="hl-2">&#39;Your name for the collection of tests in this file goes here&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">tests:</span><span class="hl-1"> [</span><br/><span class="hl-1">        {</span><br/><span class="hl-1">            </span><span class="hl-5">title:</span><span class="hl-1"> </span><span class="hl-2">&#39;The test name goes here&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-0">run</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-19">async</span><span class="hl-1"> </span><span class="hl-15">function</span><span class="hl-1">(</span><span class="hl-20">test</span><span class="hl-1">) { </span><br/><span class="hl-1">                </span><span class="hl-11">// put your test within an async function</span><br/><span class="hl-1">                </span><span class="hl-11">// For example, we want to test this addition function</span><br/><span class="hl-1">                </span><span class="hl-11">// let addition = (a,b) =&gt;  a + b</span><br/><br/><span class="hl-1">                </span><span class="hl-11">// Here you can use an assertion to determine the result of the test for example:</span><br/><span class="hl-1">                </span><span class="hl-11">// the `.is` assertion checks if result is === 42</span><br/><span class="hl-1">                </span><span class="hl-11">// test.is(addition(4,5), 42, &#39;Message&#39;);  The test fails with Message!</span><br/><span class="hl-1">                </span><br/><span class="hl-1">                </span><span class="hl-11">// the `.is` assertion checks that result === 8</span><br/><span class="hl-1">                </span><span class="hl-11">// test.is(addition(4,4), 8, &#39;Message&#39;);  The test passes!</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">    ],</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>The supported assertions can be found here: <a href="https://node-tap.org/docs/api/asserts/" target="_blank" class="external">https://node-tap.org/docs/api/asserts/</a></p>
<p>More examples of test logic can be seen here: <a href="https://github.com/balena-os/meta-balena/blob/master/tests/suites/os/tests/fingerprint/index.js" target="_blank" class="external">https://github.com/balena-os/meta-balena/blob/master/tests/suites/os/tests/fingerprint/index.js</a> for a very simple test, and here: <a href="https://github.com/balena-os/meta-balena/blob/master/tests/suites/os/tests/connectivity/index.js" target="_blank" class="external">https://github.com/balena-os/meta-balena/blob/master/tests/suites/os/tests/connectivity/index.js</a> for more complex tests.</p>
<a id="md:writing-a-new-suite" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Writing a new suite<a href="#md:writing-a-new-suite" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>A new test suite can be created using the folder structure described at the start of this document. A new folder in the suites folder will be the start of the new suite. After you are finished writing the test suite, add the path of the test suite to the <code>suite</code> property in your <code>workspace/config.js</code></p>
<p>Check out some tips and references for <a href="reference_tips.html">writing better tests</a> with Leviathan.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#md:writing-new-tests-in-leviathan"><span>Writing new tests in <wbr/>Leviathan</span></a><ul><li><a href="#md:how-do-i-add-a-new-test"><span>How do <wbr/>I add a new test?</span></a></li><li><ul><li><a href="#md:adding-a-testtests-to-an-existing-suite"><span>Adding a test/tests to an existing suite</span></a></li><li><a href="#md:writing-the-test-logic"><span>Writing the test logic</span></a></li><li><a href="#md:writing-a-new-suite"><span>Writing a new suite</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-1"></use></svg><span>Leviathan</span></a><ul class="tsd-small-nested-navigation" id="tsd-nav-container" data-base=".."><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
